<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon.png">

    <title>Elasticsearch and Webmapping</title>
    <meta name="description" content="Two hours workshop on how different ways to render Elasticsearch data on a web map application using  Maplibre.
">
    <meta name="author" content="Jorge Sanz ">

    <meta property="og:title" content="Elasticsearch and Webmapping">
    <meta property="og:image" content="./assets/banner.png">

    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/pico.css">
    <link rel="stylesheet" href="assets/css/nord.css">
    <!-- Scripts -->
    <script src="assets/js/highlight.min.js"></script>
    </head>
<body>

<script>hljs.highlightAll();</script>

<main class="container-fluid">

<hgroup>
<h1>Elasticsearch and Webmapping</h1>
<h2>Two hours workshop on how different ways to render Elasticsearch data on a web map application using  Maplibre.
</h2>
</hgroup>

<div style="text-align: center; margin: 0 0 2em 0;">
  <img style="max-width: 90%;" src="assets/banner.png">
</div>

<section>
  <h2>About</h2>
<blockquote>
<p>This is part of the larger <a href="https://github.com/jsanz/elastic-workshop/">Elastic Workshop</a> repository.</p>
</blockquote>
<p>In this two hours session, first, there are details on how to set up an Elasticsearch cluster to accept search and aggregation requests using Vector Tiles as the output format.</p>
<p>With a cluster ready, we can explore two main types of data rendering: individual documents and grid aggregations using different spatial indices.</p>
<h2>Slides</h2>
<p><a href="https://ela.st/2023-webmapping-elasticsearch-slides">https://ela.st/2023-webmapping-elasticsearch-slides</a></p>
<h2>Data preparation</h2>
<blockquote>
<p>Full details on how to install these datasets and others can be found <a href="https://gist.github.com/jsanz/235570f46634269ee354c831f87caf65">here</a></p>
</blockquote>
<p>On an Elasticsearch 8.x cluster add this setting to the <code>elasticsearch.yml</code> file to allow restoring snapshots from a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/snapshots-read-only-repository.html">Read-only URL repository</a>.</p>
<pre><code class="language-yaml">repositories.url.allowed_urls: 
        - &quot;https://storage.googleapis.com/jsanz-bucket/*&quot;
</code></pre>
<p>To accept requests for vector tiles from a browser we also need to enable CORS in Elasticsearch so, again in the <code>elasticsearch.yml</code>:</p>
<pre><code class="language-yaml">http.cors: 
    enabled : true
    allow-origin: &quot;*&quot;
    allow-methods: OPTIONS, HEAD, GET, POST
    allow-headers: &quot;X-Requested-With, Content-Type, Content-Length, Authorization, Accept, User-Agent, X-Elastic-Client-Meta, Cache-Control&quot;
</code></pre>
<blockquote>
<p>âš  Be sure to read the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html">networking documentation</a> carefully if you are working with a production cluster to understand the implications of allowing CORS requests</p>
</blockquote>
<p>Restart the cluster to activate this URL and then you can create a couple of snapshots repositories and restore some indices with <a href="https://data.cityofnewyork.us/Social-Services/311-Service-Requests-from-2010-to-Present/erm2-nwe9">NYC 311</a> data and the <a href="http://www.geonames.org/">Geonames database</a>.</p>
<details>
<summary>Loading datasets ðŸ”½</summary>
<pre><code class="language-text"># Add the NYC 311 snapshots repository
PUT /_snapshot/nyc311
{
  &quot;type&quot;: &quot;url&quot;,
  &quot;settings&quot;: {
    &quot;url&quot;: &quot;https://storage.googleapis.com/jsanz-bucket/nyc311_repo/&quot;
  }
}

# Check two snapshots are available
GET _snapshot/nyc311/*

# Restore 311 data (async)
POST /_snapshot/nyc311/snapshot_1/_restore

# Restore NYC boroughs data (async)
POST /_snapshot/nyc311/snapshot_2/_restore

# Add the Geonames snapshots repository
PUT /_snapshot/geonames
{
  &quot;type&quot;: &quot;url&quot;,
  &quot;settings&quot;: {
    &quot;url&quot;: &quot;https://storage.googleapis.com/jsanz-bucket/v8/geospatial_demos/&quot;
  }
}

# Check the geonames snapshot is available available
GET _snapshot/geonames/geonames

# Restore Geonames data (async)
POST /_snapshot/geonames/geonames/_restore
</code></pre>
</details>
<p>You need to wait for the data to be downloaded and restored. Check the indices in your cluster with:</p>
<pre><code class="language-text">GET _cat/indices?v&amp;h=index,docs.count&amp;s=index
</code></pre>
<p>Create the corresponding data views for Kibana from the Stack Management interface or with the following Console commands for the <a href="https://www.elastic.co/guide/en/kibana/master/data-views-api-create.html">Create Data View API</a></p>
<details>
<summary>Creating Kibana Data Views ðŸ”½</summary>
<pre><code class="language-text">POST kbn://api/data_views/data_view
{
  &quot;data_view&quot;: {
    &quot;title&quot;: &quot;311&quot;,
    &quot;name&quot;: &quot;NYC 311 calls&quot;,
    &quot;timeFieldName&quot;: &quot;Created Date&quot;
  }
}

POST kbn://api/data_views/data_view
{
  &quot;data_view&quot;: {
    &quot;title&quot;: &quot;nyc_boroughs&quot;,
    &quot;name&quot;: &quot;NYC Boroughs&quot;
  }
}

POST kbn://api/data_views/data_view
{
  &quot;data_view&quot;: {
    &quot;title&quot;: &quot;NYC&quot;,
    &quot;name&quot;: &quot;NYC 311 calls&quot;,
    &quot;timeFieldName&quot;: &quot;Created Date&quot;
  }
}
</code></pre>
</details>
<h2>Setting up Elasticsearch API key</h2>
<p>Create a <code>workshop</code> API key that can view the indices we just created and that will expire in five days.</p>
<details>
<summary>Create an API key ðŸ”½</summary>
<pre><code class="language-text">POST /_security/api_key
{
  &quot;name&quot;: &quot;workshop-api-key&quot;,
  &quot;expiration&quot;: &quot;5d&quot;,   
  &quot;role_descriptors&quot;: { 
    &quot;workshop&quot;: {
      &quot;index&quot;: [
      {
        &quot;names&quot;: [
          &quot;geonames&quot;,
          &quot;311&quot;,
          &quot;nyc_boroughs&quot;
        ],
        &quot;privileges&quot;: [
          &quot;read&quot;,
          &quot;view_index_metadata&quot;
        ],
        &quot;field_security&quot;: {
          &quot;grant&quot;: [
            &quot;*&quot;
          ]
        }
      }
      ]
    }
  }
}
</code></pre>
</details>
<p>Write down the result as you'll need those fields on your requests.</p>
<pre><code class="language-json">{
  &quot;id&quot;: &quot;YqAxoIgBclR1XK5t5Ixm&quot;,
  &quot;name&quot;: &quot;workshop-api-key&quot;,
  &quot;expiration&quot;: 1688906804330,
  &quot;api_key&quot;: &quot;your-api-key-here&quot;,
  &quot;encoded&quot;: &quot;your-encoded-name-and-api-key-here&quot;
}
</code></pre>
<p>You can test your API key from curl:</p>
<pre><code class="language-bash">$ ELASTIC_HOST=&quot;https://your-cluster-url&quot;
$ ELASTIC_APIKEY=&quot;your-encoded-name-and-api-key-here&quot;
$ curl -H &quot;Authorization: ApiKey ${ELASTIC_APIKEY}&quot; \
  &quot;${ELASTIC_HOST}/geonames/_count?pretty=true&quot;
</code></pre>
<p>This should return:</p>
<pre><code class="language-json">{
  &quot;count&quot; : 11968314,
  &quot;_shards&quot; : {
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  }
}
</code></pre>
<h2>Starting the viewer</h2>
<p>You can simply serve the <code>dist</code> folder from any webserver of your choice:</p>
<ul>
<li>Python: <code>python -m http.server --directory dist 8080</code></li>
<li>NodeJS: <code>npx http-server -p 8080 dist</code></li>
<li>etc.</li>
</ul>
<p>Or if you are familiar with the NodeJS stack then you can download the dependencies (<code>yarn install</code> or  <code>npm install</code>) and start a development server (<code>yarn start</code> or <code>npm start</code>) so you can edit the code in the source files and the page will reload automatically.</p>
<ul>
<li><code>_includes/map.njk</code> contains the common code to initialize the different map pages</li>
<li><code>pages/X.html</code> contains the HTML markup and the JavaScript code to run that page.</li>
</ul>
<p>The target <code>yarn build</code> or <code>npm build</code> will generate the output files in the <code>dist</code> folder that can be uploaded to any static webserver (Github Pages, Vercel, Netlify, and so on).</p>

</section>

<section>
  <h2>ðŸ—º Maps! ðŸ—º</h2>
  
  <dl>
    <dt><a href="/jsanz-bucket/vector-tile-viewer/basemap.html">Just the basemap</a></dt>
    <dd>Just rendereing the basemap from PMTiles vector tiles and  Elastic OSM Bright desaturated schema
</dd>
    <dt><a href="/jsanz-bucket/vector-tile-viewer/documents.html">Documents: render everything between two dates</a></dt>
    <dd>Learn how to render Elasticsearch data with a simple query into a Maplibre layer.
</dd>
    <dt><a href="/jsanz-bucket/vector-tile-viewer/documents-filter.html">Documents: terms query and thematic mapping</a></dt>
    <dd>Extend your basic layer with a color palette depending on the value of a document field.
</dd>
    <dt><a href="/jsanz-bucket/vector-tile-viewer/documents-popup.html">Documents: add a popup</a></dt>
    <dd>Include more fields on the vector tiles retrieved to allow showing a pop up with details of each 311 call.
</dd>
    <dt><a href="/jsanz-bucket/vector-tile-viewer/documents-search.html">Documents: search</a></dt>
    <dd>Filter data on the map by including a text string from an input form that will search for all fields in our index.
</dd>
    <dt><a href="/jsanz-bucket/vector-tile-viewer/hexagons.html">Hexagons</a></dt>
    <dd>Aggregate 311 calls using the H3 hexagon spatial index.
</dd>
    <dt><a href="/jsanz-bucket/vector-tile-viewer/hexagons-adaptative.html">Hexagons: adaptative legend</a></dt>
    <dd>Change the legend of the hexagons aggregated Maplibre layer depending on the zoom level.
</dd>
    <dt><a href="/jsanz-bucket/vector-tile-viewer/hexagons-cardinality.html">Hexagons: additional metric</a></dt>
    <dd>Include a new custom metric in the data aggregation.
</dd>
    <dt><a href="/jsanz-bucket/vector-tile-viewer/geotile-square.html">Geotile: square tiles</a></dt>
    <dd>Aggregate using square tiles and extend the Elasticsearch  query to exclude some outlier data.
</dd>
    <dt><a href="/jsanz-bucket/vector-tile-viewer/geotile-heatmap.html">Geotile: heatmap</a></dt>
    <dd>Use a heatmap styling to render geotile aggregated data. 
</dd>
  </dl>
</section>


</main>

</body>
</html>

