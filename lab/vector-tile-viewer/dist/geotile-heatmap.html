<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon.png">

    <title>Geotile: heatmap</title>

    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/maplibre-gl.css">
    <link rel="stylesheet" href="assets/css/map-and-info.css">
    <!-- Scripts -->
    <script src="assets/js/maplibre-gl-dev.js"></script>
    <script src="assets/js/pmtiles.js"></script>
    </head>
<body>
<!-- Map initialization  -->
<script>
      /* Basemap style provided by Maptiler */
      const MAP_STYLE = './assets/style.json';
      /* ES instance with geodata and anonymous access enabled */
      const ES_HOST = "https://webmapping.es.europe-west1.gcp.cloud.es.io";
      /* ES API Key to access our data */
      const ES_APIKEY = "WktBX29JZ0JjbFIxWEs1dEw0dzk6aFVVUVZKMnpSTW1tWktlai1sd1k3dw==";

      /* initialize pmtiles support */
      let protocol = new pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles",protocol.tile);
</script>

<!-- Map Code -->

<div id="map"></div>
<div id="info">
    <h3>311 noise claims<br> between 2015 and 2020</h3>
</div>
<script>
    /* ES index and geometry field */
    const ES_INDEX = '311';
    const ES_FIELD = 'location';

    /* VT request */
    const ES_TILES = `${ES_HOST}/${ES_INDEX}/_mvt/${ES_FIELD}/{z}/{x}/{y}`;

    /* VT query for hits */
    const ES_SEARCH_BODY = {
        size: 0,
        grid_precision: 8,
        exact_bounds: false,
        extent: 4096,
        grid_agg: "geotile",
        grid_type: "grid",
        with_labels: true,
        fields: [
            "Complaint Type",
            "Agency Name",
            "Closed Date",
            "Incident Address",
            "Location Type",
            "Resolution Description",
            "Status"
        ],
        query: {
            "bool": {
                "filter": [
                    {
                        "range": {
                            "Created Date": {
                                "gte": "2015-01-01",
                                "lte": "2021-01-01"
                            }
                        }
                    },
                    {
                        "terms": {
                            "Complaint Type": [
                                "Noise - Residential",
                                "Noise - Street/sidewalk",
                                "Noise - Vehicle",
                                "Noise - Commercial",
                                "Noise - Helicopter",
                                "Noise - Park",
                                "Noise"
                            ]
                        }
                    }
                ]
            }
        }
    };
    const INITIAL_ZOOM = 10;
    const MIN_ZOOM = 10;
    const MAX_ZOOM = 14;
    const intFormatter = new Intl.NumberFormat('en-US', { maximumSignificantDigits: 3 });


    const map = new maplibregl.Map({
        container: 'map',
        style: MAP_STYLE,
        center: [-73.95, 40.7],
        zoom: INITIAL_ZOOM,
        minZoom: MIN_ZOOM,
        maxZoom: MAX_ZOOM,
        hash: true,
        transformRequest: function (url, resourceType) {
            /* This function enriches the HTTP request to include
            the ES search body, change to a POST request, and include
            the Content-Type header */
            if (resourceType == 'Tile' && url.startsWith(ES_HOST)) {
                return {
                    url: url,
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' ,
                        'Authorization': `ApiKey ${ES_APIKEY}`
                    },
                    type: 'arrayBuffer',
                    body: JSON.stringify(ES_SEARCH_BODY)
                }
            }
        }
    });

    map.addControl(new maplibregl.NavigationControl());

    map.on('load', function () {
        /* Source for ES data */
        map.addSource('ES', {
            'type': 'vector',
            'tiles': [ES_TILES],
            'minzoom': 0,
            'maxzoom': MAX_ZOOM,
            'attribution': '<a href=Â¨"https://elastic.co">Elasticsearch data</a>'
        });

        map.addLayer(
            {
                'id': 'data',
                'type': 'heatmap',
                'source': 'ES',
                'source-layer': 'aggs',
                'paint': {
                    'heatmap-weight': [
                        'interpolate',
                        ['linear'],
                        ['get','_count'],
                        0,
                        0,
                        10000,
                        1
                    ],
                    'heatmap-color': [
                        'interpolate',
                        ['linear'],
                        ['heatmap-density'],
                        0,
                        'rgba(0,0,0,0)',
                        0.2,
                        '#fe9f6d',
                        0.4,
                        '#de4968',
                        0.6,
                        '#8c2981',
                        0.8,
                        '#3b0f70',
                        1,
                        '#000004'
                    ],
                    // Adjust the heatmap radius by zoom level
                    'heatmap-radius': 20
                }
            }
        );
    });
</script>

</body>
</html>

