<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon.png">

    <title>Documents: terms query and thematic mapping</title>
    <meta name="description" content="Extend your basic layer with a color palette depending on the value of a document field.
">
    <meta name="author" content="Jorge Sanz ">

    <meta property="og:title" content="Documents: terms query and thematic mapping">
    <meta property="og:image" content="./assets/banner.png">

    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/maplibre-gl.css">
    <link rel="stylesheet" href="assets/css/map-and-info.css">
    <!-- Scripts -->
    <script src="assets/js/maplibre-gl-dev.js"></script>
    <script src="assets/js/pmtiles.js"></script>
    </head>
<body>
<!-- Map initialization  -->
<script>
    /* Basemap style provided by Maptiler */
    const MAP_STYLE = './assets/style.json';
    /* ES instance with geodata and anonymous access enabled */
    const ES_HOST = "https://webmapping.es.europe-west1.gcp.cloud.es.io";
    /* ES API Key to access our data */
    const ES_APIKEY = "V2lJd3NJZ0JrLWZOVlduTFJGX1Q6U2xfdjhrXzlTbW1KNm1xOWF2OGFyUQ==";

    /* initialize pmtiles support */
    let protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles",protocol.tile);
</script>


<!-- getTransformRequest  -->
<script>
const getTransFormRequest = function (url, resourceType) {
    /* This function enriches the HTTP request to include
    the ES search body, change to a POST request, and include
    the Content-Type and authorization headers */
    if (resourceType == 'Tile' && url.startsWith(ES_HOST)) {
        return {
            url: url,
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `ApiKey ${ES_APIKEY}`
            },
            type: 'arrayBuffer',
            body: JSON.stringify(ES_SEARCH_BODY)
        }
    }
}

// Rendering counts
const intFormatter = new Intl.NumberFormat('en-US',{
  minimumFractionDigits: 0,
  maximumFractionDigits: 0,
});

const getCount = function(features){
    const dataFeatures = features.filter(f => f?.layer?.id == 'data');
    let count;
   
    // Features can be single documents or aggregated hex or grid
    if (! dataFeatures) {
        return;
    } else if (dataFeatures[0]?.properties.hasOwnProperty('_count')){
        count = dataFeatures.reduce((acc, cur) => acc + cur.properties._count, 0);
    } else {
        count = dataFeatures.length ;
    }

    // Fix NYC 311 duplicate data issue
    return count / 2;
}
const counts = function() {
    const features = map.queryRenderedFeatures();
    const countEl = document.getElementById('count');
    const preCount = countEl.textContent;
    
    const count = getCount(features);

    if (!count) return;

    // Render the count
    const formattedCount = intFormatter.format(count);
    if (preCount != formattedCount) {
        countEl.textContent = formattedCount;
    }
};
</script>


<div id="map"></div>
<div id="info">
    <h3>311 noise claims from 2019 Q1</h3>
    <p>Click on a point to get details</p>
    <p>Count: <strong><span id="count"></span></strong></p>
</div>
<script>
    /* ES index and geometry field */
    const ES_INDEX = '311';
    const ES_FIELD = 'location';

    /* VT request */
    const ES_TILES = `${ES_HOST}/${ES_INDEX}/_mvt/${ES_FIELD}/{z}/{x}/{y}`;

    /* VT query for hits */
    const ES_SEARCH_BODY = {
        grid_precision: 0,
        exact_bounds: true,
        extent: 4096,
        track_total_hits: 10001,
        fields: [
            "Complaint Type",
            "Descriptor",
            "Agency Name",
            "Closed Date",
            "Incident Address",
            "Location Type",
            "Resolution Description",
            "Status"
        ],
        query: {
            "bool": {
                "filter": [
                    {
                        "range": {
                            "Created Date": {
                                "gte": "2019-01-01",
                                "lte": "2019-04-01"
                            }
                        }
                    },
                    {
                        "terms": {
                            "Complaint Type": [
                                "Noise - Residential",
                                "Noise - Street/sidewalk",
                                "Noise - Vehicle",
                                "Noise - Commercial",
                                "Noise - Helicopter",
                                "Noise - Park",
                                "Noise"
                            ]
                        }
                    }
                ]
            }
        }
    };

    const map = new maplibregl.Map({
        container: 'map',
        style: MAP_STYLE,
        center: [-73.95, 40.7],
        zoom: 10,
        hash: true,
        transformRequest: getTransFormRequest
    });

    map.addControl(new maplibregl.NavigationControl());

    map.on('load', function () {
        /* Source for ES data */
        map.addSource('ES', {
            'type': 'vector',
            'tiles': [ES_TILES],
            'minzoom': 0,
            'maxzoom': 14,
            'attribution': '<a href="https://portal.311.nyc.gov/">NYC 311</a>'
        });

        map.addLayer(
            {
                'id': 'data',
                'type': 'circle',
                'source': 'ES',
                'source-layer': 'hits',
                'paint': {
                    'circle-radius': 3,
                    /* Thematic mapping for the Complaint Type field */
                    'circle-color': [
                        'match',
                        ['get', 'Complaint Type'],
                        "Noise - Residential", "#54B399",
                        "Noise", "#6092C0",
                        "Noise - Commercial", "#D36086",
                        "Noise - Street/Sidewalk", "#9170B8",
                        "Noise - Vehicle", "#CA8EAE",
                        "Noise - Park", "#D6BF57",
                        "Noise - Helicopter", "#B9A888",
                        "Noise - House of Worship", "#DA8B45",
                        "Noise Survey", "#AA6556",
                    /*other*/ '#ccc'
                    ],
                    'circle-opacity': 0.9,
                }
            }
        );
    });

    /* Adding a count based entirely on client features */
    map.on('data', counts);
    map.on('moveend', counts);
</script>


</body>
</html>

